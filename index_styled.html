<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Culinary Quest üçΩÔ∏è</title>

<style>
  :root{--gold:#f59e0b;--amber:#fef3c7;--muted:#6b7280;--ok:#16a34a;--danger:#dc2626;--accent:#ea580c}
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{min-height:100%}
  body{
    font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial;
    background:linear-gradient(135deg,#fff8ec,#fdf4e3,#fef9c3);
    color:#111827;
    -webkit-font-smoothing:antialiased;
  }
  input,button,textarea{font-size:16px}
  .container{max-width:1000px;margin:0 auto;padding:16px}
  .card{background:#fff;border-radius:14px;padding:18px;box-shadow:0 10px 24px rgba(0,0,0,.12);margin:12px auto}
  .title{font-size:1.9rem;font-weight:900;text-align:center;margin-bottom:6px}
  .subtitle{opacity:.95;text-align:center;margin-bottom:12px}
  .btn{border:none;border-radius:999px;padding:.9rem 1.2rem;font-weight:800;cursor:pointer}
  .btn-lg{padding:1rem 1.45rem;font-size:1.05rem}
  .btn-success{background:var(--ok);color:#fff}
  .btn-danger{background:var(--danger);color:#fff}
  .btn-secondary{background:var(--accent);color:#fff}
  .btn-ghost{background:#fff;border:1px solid #e5e7eb;color:#374151;border-radius:10px;padding:.55rem .9rem}
  .muted{color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .actions{display:flex;gap:12px;justify-content:center;margin-top:14px;flex-wrap:wrap}
  input,textarea{width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:.6rem .75rem}
  textarea{min-height:90px;resize:vertical}
  .list{margin-top:10px}
  .list-item{display:flex;justify-content:space-between;align-items:center;padding:.65rem .8rem;border:1px solid #eef2f7;border-radius:10px;background:#fff;margin-bottom:8px}
  .badge{background:#3b82f6;color:#fff;font-size:.78rem;border-radius:8px;padding:.15rem .45rem;margin-left:8px}
  .grid-2{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:720px){.grid-2{grid-template-columns:1fr 1fr}}
  .option{border:2px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff;cursor:pointer;transition:border-color .2s,box-shadow .2s}
  .option.selected{border-color:var(--gold);box-shadow:0 6px 20px rgba(245,158,11,.18)}
  .option-title{font-weight:900;margin-bottom:3px}
  .option-desc{color:var(--muted)}
  .cat-grid{display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px}
  @media(min-width:560px){.cat-grid{grid-template-columns:1fr 1fr}}
  /* Replace your existing .cat-chip and .cat-chip span rules with exactly these */
  .cat-chip{
  display:flex;
  align-items:center;
  gap:8px;
  width:100%;
  min-height:36px;               /* ensures readable target on iOS */
  padding:8px 10px;
  border:1px solid rgba(0,0,0,.12);
  border-radius:999px;
  background:#fff;
  white-space:normal;            /* allow wrapping on narrow screens */
}
  .cat-chip span{
  flex:1 1 auto;
  min-width:0;                    /* allow ellipsis to work in flexbox */
  overflow:hidden;                /* truncation lives on the span only */
  text-overflow:ellipsis;
  display:block;                 /* stable on iOS flexbox */
  line-height:1.2;               /* avoids vertical clipping */
}
  .cat-chip input{
  width:18px;
  height:18px;
  flex:0 0 18px;                 /* fixed basis so text always gets space */
  margin-left:2px;
  margin-right:8px;
  align-self:center;
}
  .lock{font-size:.75rem;color:#9ca3af;margin-left:6px}
  .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);z-index:1100;background:#111827;color:#fff;padding:.6rem 1rem;border-radius:999px;box-shadow:0 10px 30px rgba(0,0,0,.3);font-weight:700;opacity:0}
  @keyframes tin{from{opacity:0;transform:translate(-50%,18px)}to{opacity:1;transform:translate(-50%,0)}}
  @keyframes tout{from{opacity:1;transform:translate(-50%,0)}to{opacity:0;transform:translate(-50%,18px)}}
  .toast.show{animation:tin .28s ease-out forwards}
  .fade{animation:fade .28s ease-out both}
  @keyframes fade{from{opacity:0}to{opacity:1}}
  .logo{width:84px;height:84px;margin:10px auto 0;display:block}
  .slogan{margin-top:10px;font-weight:700;color:#7c5a00;background:#fff8db;border:2px solid var(--gold);border-radius:12px;padding:.7rem .9rem;opacity:.95;text-align:center}
  .banner{background:#dbeafe;border:1px solid #bfdbfe;border-radius:10px;padding:10px}
  .reset-btn{position:fixed;bottom:20px;right:20px;background:#ef4444;color:#fff;padding:10px 16px;border-radius:999px;font-weight:800;cursor:pointer;box-shadow:0 4px 14px rgba(0,0,0,.2);z-index:2000;display:none}
</style>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet"/>

<style id="cq-styled">
/* ---- Scoped, non-destructive polish for index_styled.html ---- */
.styled { font-family: "Plus Jakarta Sans", -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial; line-height:1.45; }
.styled .title{ letter-spacing:-.01em; font-weight:800; }
.styled .subtitle{ color:#4b5563 }
.styled .card{ border:1px solid #eceff3; border-radius:16px; box-shadow:0 10px 28px rgba(0,0,0,.08) }
.styled .list-item{ border-radius:12px; border:1px solid #eef2f7 }
.styled .btn{ transition:transform .06s ease, box-shadow .15s ease, background-color .15s ease; font-weight:800; letter-spacing:.015em }
.styled .btn:hover{ transform:translateY(-1px); box-shadow:0 6px 22px rgba(0,0,0,.12) }
.styled .btn:active{ transform:translateY(0) }
.styled input, .styled textarea, .styled select{ border-radius:12px; border:1px solid #e5e7eb; background:#fff; outline:none }
.styled input:focus, .styled textarea:focus, .styled select:focus{ border-color:#f59e0b; box-shadow:0 0 0 3px rgba(245,158,11,.15) }
.styled .badge{ border-radius:10px; padding:.1rem .45rem }
.styled .actions { gap:14px }
.styled .muted{ color:#6b7280 }
.styled .slogan{ border-width:2px; border-color:#f59e0b }
/* chips */
.styled .chip{ display:inline-block; border:1px solid #e5e7eb; border-radius:999px; padding:.25rem .6rem; margin:.2rem .3rem; color:#6b7280; font-size:.85rem }
.styled .chip.taken{ opacity:.6; text-decoration:line-through }
/* ---- Start screen hero styles (scoped) ---- */
.styled .hero-wrap{ position:relative; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px }
.styled .hero-bg{ position:absolute; inset:0; background-position:center; background-size:cover; filter:brightness(.68) }
.styled .hero-overlay{ position:absolute; inset:0;
  background: radial-gradient(1200px 800px at 70% 20%, rgba(255,215,130,.18), transparent 40%),
              radial-gradient(1000px 700px at 20% 80%, rgba(255,180,60,.12), transparent 40%),
              linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.75));
}
.styled .hero-inner{ position:relative; z-index:1; width:100%; max-width:920px }
.styled .hero-card{ background:rgba(255,255,255,.9); border:1px solid #eceff3; border-radius:18px; box-shadow:0 24px 60px rgba(0,0,0,.18); overflow:hidden }
.styled .hero-header{ padding:22px 22px 0 22px; text-align:center }
.styled .hero-title{ font-size:2rem; font-weight:800; color:#1f2937; letter-spacing:-.01em }
.styled .hero-sub{ color:#4b5563; margin-top:6px }
.styled .hero-body{ padding:18px 22px }
.styled .hero-ol{ margin:8px 0 0 20px; line-height:1.55; color:#374151 }
.styled .hero-footer{ display:flex; gap:12px; justify-content:center; padding:18px 22px 22px 22px }
.styled .hint{ font-size:.85rem; color:#6b7280; margin-top:6px; text-align:center }
.styled .name-note{ font-size:.85rem; color:#6b7280; margin-top:6px }
@media (min-width: 720px){ .styled .hero-title{ font-size:2.2rem } }
</style>

</head>
<body class="styled">
<div class="container" id="app"></div>
<div id="devReset" class="reset-btn">üßπ Reset Game Data</div>

<!-- Firebase (ESM) -->
<script type="module">
  const DEV_MODE = true;

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getDatabase, ref, onValue, set, remove, get, child, update } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDfwN_5WYj9AKFqDWkEEIrUIwjL8XaZ7oQ",
    authDomain: "culinary-quest-f2777.firebaseapp.com",
    databaseURL: "https://culinary-quest-f2777-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "culinary-quest-f2777",
    storageBucket: "culinary-quest-f2777.firebasestorage.app",
    messagingSenderId: "214188908997",
    appId: "1:214188908997:web:519064cad50efe615e2bac",
    measurementId: "G-EMF9YGM2LT"
  };

  // Init Firebase
  let app, db;
  try{ app = initializeApp(firebaseConfig); db = getDatabase(app); window.__CQ_FB_READY__=true; }catch(e){ console.warn(e); window.__CQ_FB_READY__=false; }
  const dbr = (path)=> ref(db, path);
  const readOnce = (path)=> get(dbr(path)).then(s=> s.exists()? s.val(): null);
  const patch = async (path, delta)=>{
     // why: server-side merge prevents lost updates across clients
    await update(dbr(path), delta);
  };

  // Utils
  const $ = sel => document.querySelector(sel);
  const appRoot = $('#app');
  const qs = new URLSearchParams(location.search);
  const baseUrl = ()=> location.href.split('?')[0];
  const REV = new Date(document.lastModified || Date.now())
  .toLocaleString([], { year:'2-digit', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' });
  const dbg = (...args) => console.debug('[CQ]', ...args);
  let offGameListener = null; // why: avoid accumulating onValue listeners
  const randId = ()=>'cq_'+Math.random().toString(36).slice(2,9);
  const fmtISO = d=>{const x=new Date(d);return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}`};
  const fmtDateTime = (iso, time)=>{
    if(!iso) return 'Pending';
    const d = new Date(iso + 'T' + (time||'00:00'));
    const dt = d.toLocaleDateString([], {year:'numeric',month:'short',day:'numeric'});
    const tm = time? (' @ ' + d.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'})) : '';
    return dt + tm;
  };
  const votingUnlock = (iso,time)=>{
  if (DEV_MODE) return null;     // TEMP: testing unlock
  if(!iso) return null;
  const d = new Date(iso + 'T' + (time||'00:00'));
  const ms = d.getTime() + (time ? 6*3600e3 : 24*3600e3);
  return new Date(ms);
};

  const toast = (msg, dur=1500)=>{
    const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t);
    requestAnimationFrame(()=> t.classList.add('show'));
    setTimeout(()=>{ t.style.animation='tout .35s ease-in forwards'; setTimeout(()=>t.remove(),380); }, dur);
  };

  const COPY = {
    splash: [
      "üçΩÔ∏è Cook. Compete. Conquer.",
      "üî• Your dining table just became centre stage!",
      "ü•á Who will be crowned the Culinary Conquistador?",
      "üé≠ Every bite earns a score. Every dish tells a story.",
      "ü•Ç One kitchen. One crown. Infinite bragging rights.",
      "üé¨ Because every great meal deserves a little drama.",
      "üî• Fire up the oven ‚Äî it‚Äôs showtime!",
      "‚ú® Serve your best. Score the rest."
    ],
    organiser: {
      game_started: "üé¨ And we‚Äôre live! Round One of the Quest begins now.",
      next_round: "üç∑ On to the next host ‚Äî keep those scores coming!",
      all_scores_in: "üèÅ Scores complete! Ready to reveal the Culinary Conquistador?",
      link_copied: "üîó Invite link copied ‚Äî your contestant awaits!",
      guest_added: "üëã A new challenger enters the kitchen!"
    },
    player: {
      invitation_accepted: "‚úÖ You‚Äôre officially in the Quest ‚Äî time to bring your A-game!",
      hosting_date_chosen: "üìÜ Great pick! Your culinary spotlight awaits.",
      score_submitted: "ü•Ñ Score locked in ‚Äî let‚Äôs see how the rankings simmer.",
      host_cannot_score: "üçΩÔ∏è Tonight you‚Äôre the star ‚Äî no judging your own masterpiece!",
      voting_not_open: "‚è∞ The judging table opens soon. Keep your forks poised."
    },
    results: {
      winner_reveal: "üé∫ Drumroll, please... presenting our Culinary Conquistador!",
      tie_reveal: "ü§ù It‚Äôs a tie! Two taste titans share the crown!",
      start_new_competition: "üî• Ready for a rematch? A new Quest awaits!"
    }
  };

  // Session helpers
  const getSession = ()=> { try{return JSON.parse(localStorage.getItem('cq_active_game')||'{}')}catch{return{}} };
  const setSession = (s)=> localStorage.setItem('cq_active_game', JSON.stringify(s));
  const clearSession = ()=> localStorage.removeItem('cq_active_game');
    const myId = ()=> {
    // Prefer URL param (fresh) over any stale session value
    const qsp = new URLSearchParams(location.search);
    if (qsp.has('c')) return parseInt(qsp.get('c'), 10);
    try { const s = getSession(); if (typeof s.contestantId==='number') return s.contestantId; } catch {}
    return null;
  };

  // Logo (SVG)
  const logoSVG = `
    <svg class="logo" viewBox="0 0 120 120" aria-hidden="true">
      <circle cx="60" cy="60" r="38" fill="#fff" stroke="#e5e7eb" stroke-width="3"></circle>
      <circle cx="60" cy="60" r="28" fill="#f9fafb"></circle>
      <g transform="translate(36,30) rotate(-35 24 30)">
        <rect x="22" y="18" width="4" height="32" rx="2" fill="#f59e0b"></rect>
        <rect x="21" y="12" width="2" height="8" rx="1" fill="#f59e0b"></rect>
        <rect x="23" y="12" width="2" height="8" rx="1" fill="#f59e0b"></rect>
        <rect x="25" y="12" width="2" height="8" rx="1" fill="#f59e0b"></rect>
        <rect x="27" y="12" width="2" height="8" rx="1" fill="#f59e0b"></rect>
      </g>
      <g transform="translate(54,30) rotate(30 6 30)">
        <rect x="5" y="16" width="4" height="36" rx="2" fill="#f59e0b"></rect>
        <path d="M7 6 C12 12, 12 14, 7 18 C2 14, 2 12, 7 6 Z" fill="#f59e0b"></path>
      </g>
    </svg>`;

  // ---------- RENDERERS ----------
  function render(html){ appRoot.innerHTML = html; }

  // Screen 1: Intro
  
function screen1(){
  dbg('screen1()');
  const heroImg = "https://images.unsplash.com/photo-1484723091739-30a097e8f929?q=80&w=1920&auto=format&fit=crop"; // replace with your own asset if desired
  const s = `
    <div class="hero-wrap">
      <div class="hero-bg" style="background-image:url('${heroImg}')"></div>
      <div class="hero-overlay"></div>

      <div class="hero-inner">
        <div class="hero-card fade">
          <div class="hero-header">
            ${logoSVG}
            <div class="muted" style="font-size:.75rem; text-align:right">Rev: ${REV}</div>
            <h1 class="hero-title">Welcome, Master of Ceremonies</h1>
            <p class="hero-sub">Define the rules. Invite your guests. Let the best host win.</p>
          </div>

          <div class="hero-body">
            <p>How it works:</p>
            <ol class="hero-ol">
              <li><b>Pick a scoring style</b> ‚Äî a simple 0‚Äì10, or category-by-category.</li>
              <li><b>Add your contestants</b> ‚Äî each receives a personal invite link.</li>
              <li><b>They RSVP with a unique date</b> ‚Äî every player hosts once.</li>
              <li><b>After the final dinner</b> ‚Äî reveal the results and crown the winner.</li>
            </ol>

            <div class="row" style="margin-top:14px; justify-content:center">
              <input id="organiserName" placeholder="Your name (visible to all players)" style="max-width:460px"/>
            </div>
            <div class="name-note">Please enter <b>your</b> name as you want others to see it.</div>
          </div>

          <div class="hero-footer">
            <button id="btnContinue" class="btn btn-success btn-lg">Begin planning</button>
            <button id="btnCancel" class="btn btn-ghost btn-lg">Cancel</button>
          </div>
          <p class="hint">You can adjust settings before starting the competition.</p>
        </div>
      </div>
    </div>`;

  render(s);
  // keep behaviour identical
  $('#btnContinue').onclick = ()=>{
    const name = ($('#organiserName').value||'').trim();
    if(!name){ toast('Please enter your name'); return; }
    window.__WIZ__ = { name, mode:'s', cats:['Food'], customs:[], players:[name], links:[], gameId:null };
    screen2();
  };
  $('#btnCancel').onclick = ()=>{ toast('üëã Come back soon!'); setTimeout(()=> location.href=baseUrl(), 900); };
}


  // Results
  function screenResults(gid){
    onValue(dbr(`games/${gid}`),(snap)=>{
      if(!snap.exists()) return;
      const x=snap.val();
      if(x.st!==4){ route(); return; }
      const totals = (x.p||[]).map((n,idx)=>{
        let total=0;
        Object.values(x.sc?.[idx]||{}).forEach(s=>{
          if(s==null) return;
          if(x.m?.sm==='s'){ if(typeof s==='number') total+=s; }
          else { if(s && typeof s.o==='number') total+=s.o; }
        });
        return { name:n, total, idx };
      }).sort((a,b)=>b.total-a.total);
      const top = totals[0]?.total ?? 0;
      const winners = totals.filter(r=>r.total===top);
      const tie = winners.length>1;

      const s=`
        <div class="card fade">
          <h1 class="title">üèÜ Final Results</h1>
          <div style="background:var(--amber);border:4px solid var(--gold);padding:16px;border-radius:12px;text-align:center">
            ${tie ? `
              <h2>${COPY.results.tie_reveal}</h2>
              <div style="margin-top:8px">${winners.map(w=>`<div style="font-weight:700">${w.name}</div>`).join('')}</div>
            ` : `
              <h2>${COPY.results.winner_reveal}</h2>
              <div style="font-weight:700;font-size:1.25rem">${winners[0]?.name||'‚Äî'}</div>
            `}
          </div>
          <h3 style="margin-top:12px">Final Leaderboard</h3>
          <div style="margin-top:8px">
            ${totals.map((r,i)=>`<div class="list-item"><div><strong>#${i+1}</strong> <span style="margin-left:8px">${r.name}</span></div><div style="font-weight:700;color:var(--accent)">${r.total}</div></div>`).join('')}
          </div>
          <div style="margin-top:12px">
            <button id="newGame" class="btn btn-secondary">${COPY.results.start_new_competition}</button>
          </div>
        </div>`;
      render(s);
      $('#newGame').onclick = async ()=>{
        await remove(dbr(`games/${gid}`)); clearSession(); location.href=baseUrl();
      };
    });
  }

  // Router
async function route(){
  // fresh query parse on every navigation
  const qsp = new URLSearchParams(location.search);
  dbg('route()', { qs: Object.fromEntries(qsp), session: getSession() });

  const s = getSession();
  const gid = qsp.get('game') || s.gameId;
  const cid = qsp.has('c') ? parseInt(qsp.get('c'), 10)
                           : (typeof s.contestantId === 'number' ? s.contestantId : myId());

  if (!gid) { screen1(); return; }

  // show something immediately (avoid blank screen)
  render(`<div class="card fade"><p class="muted">Loading‚Ä¶</p></div>`);

  if (!window.__CQ_FB_READY__) {
    render(`
      <div class="card fade">
        ${logoSVG}
        <h2 class="title">Unable to load</h2>
        <p class="muted">App not initialised. Please refresh and try again.</p>
      </div>
    `);
    return;
  }

  try {
    const x = await readOnce(`games/${gid}`);
    if (!x) {
      render(`
        <div class="card fade">
          ${logoSVG}
          <h2 class="title">Game not found</h2>
          <p class="muted">This game ID was not found. Ask the organiser to resend the link.</p>
        </div>
      `);
      return;
    }

    // persist session if missing
        if (qsp.has('game') || qsp.has('c') || !s.gameId) {
      setSession({ gameId: gid, contestantId: (Number.isInteger(cid) ? cid : 0) });
    }

    if (x.st === 1) {
      const pLen = (x.p || []).length;
      const isValidCid = Number.isInteger(cid) && cid >= 0 && cid < pLen;
      if (!isValidCid) {
        render(`
          <div class="card fade">
            ${logoSVG}
            <h2 class="title">Invalid Invitation Link</h2>
            <p class="muted">This link doesn‚Äôt match any participant in this game.</p>
          </div>
        `);
        return;
      }
      if ((cid ?? 0) === 0) {
        screen5();            // organiser
      } else {
        screenInvite(gid, cid); // guest invite flow
      }
    } else if (x.st === 2) {
  // Only guests explicitly reopened by the organiser may (re)pick after start
  const pLen = (x.p||[]).length;
  const isValidCid = Number.isInteger(cid) && cid >= 0 && cid < pLen;
  const status = isValidCid ? x.rsvp?.[cid] : undefined;
  const reopened = isValidCid ? (x.ro?.[cid] === 1) : false;

  if (isValidCid && cid > 0 && status === 0 && reopened) {
    screenInvite(gid, cid);
  } else {
    screenGame(gid);
  }
} else if (x.st === 4) {
      screenResults(gid);
    } else {
      screen1();
    }
  } catch (err) {
    console.error('[CQ] route() read failed', err);
    const code = err?.code || 'UNKNOWN';
    const msg =
      code === 'PERMISSION_DENIED' ? 'This game is not readable. Ask the organiser to adjust Firebase rules.' :
      code === 'NETWORK_REQUEST_FAILED' ? 'Network error. Check your connection and try again.' :
      'Please check your connection and try again.';

    render(`
      <div class="card fade">
        ${logoSVG}
        <h2 class="title">Unable to load</h2>
        <p class="muted">${msg}</p>
        <p class="muted" style="font-size:.85rem">Error code: <code>${code}</code></p>
        <div class="actions">
          <button class="btn btn-primary" id="btnRetry">Retry</button>
        </div>
      </div>
    `);
    const btn = document.getElementById('btnRetry');
    if (btn) btn.onclick = ()=> route();
  }
} // ‚Üê ensure this closing brace is present (route() ends here)

  // DEV reset
  if(DEV_MODE){
    const el = $('#devReset'); el.style.display='block';
    el.onclick = async ()=>{
      const s = getSession();
      if(!s.gameId){ alert('No active game'); return; }
      if(!confirm('Delete the current game and clear all data?')) return;
      try{ await remove(dbr(`games/${s.gameId}`)); }catch(e){ console.error(e); }
      clearSession(); alert('Cleared. Reloading‚Ä¶'); location.href=baseUrl();
    };
  }

  // Bootstrap
  route();
</script>
</body>
</html>
